{"version":3,"sources":["../src/index.js"],"names":["throwError","isNodePattern","rotate90degrees","bitmap","dstBuffer","clockwise","dstOffsetStep","dstOffset","length","tmp","x","y","srcOffset","width","height","data","readUInt32BE","writeUInt32BE","simpleRotate","deg","steps","Math","round","srcBuffer","len","Buffer","allocUnsafe","advancedRotate","mode","rad","PI","cosine","cos","sine","sin","w","h","ceil","abs","c","cloneQuiet","scanQuiet","idx","_background","max","resize","blit","bW","bH","alloc","createTranslationFunction","deltaX","deltaY","translate2Cartesian","translate2Screen","cartesian","source","dstIdx","srcIdx","pixelRGBA","crop","rotate","cb","call","Boolean"],"mappings":"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","sourcesContent":["import { throwError, isNodePattern } from '@jimp/utils';\n\nfunction rotate90degrees(bitmap, dstBuffer, clockwise) {\n  const dstOffsetStep = clockwise ? -4 : 4;\n  let dstOffset = clockwise ? dstBuffer.length - 4 : 0;\n\n  let tmp;\n  let x;\n  let y;\n  let srcOffset;\n\n  for (x = 0; x < bitmap.width; x++) {\n    for (y = bitmap.height - 1; y >= 0; y--) {\n      srcOffset = (bitmap.width * y + x) << 2;\n      tmp = bitmap.data.readUInt32BE(srcOffset, true);\n      dstBuffer.writeUInt32BE(tmp, dstOffset, true);\n      dstOffset += dstOffsetStep;\n    }\n  }\n}\n\n/**\n * Rotates an image clockwise by a number of degrees rounded to the nearest 90 degrees. NB: 'this' must be a Jimp object.\n * @param {number} deg the number of degrees to rotate the image by\n */\nfunction simpleRotate(deg) {\n  let steps = Math.round(deg / 90) % 4;\n  steps += steps < 0 ? 4 : 0;\n\n  if (steps === 0) return;\n\n  const srcBuffer = this.bitmap.data;\n  const len = srcBuffer.length;\n  const dstBuffer = Buffer.allocUnsafe(len);\n\n  let tmp;\n\n  if (steps === 2) {\n    // Upside-down\n    for (let srcOffset = 0; srcOffset < len; srcOffset += 4) {\n      tmp = srcBuffer.readUInt32BE(srcOffset, true);\n      dstBuffer.writeUInt32BE(tmp, len - srcOffset - 4, true);\n    }\n  } else {\n    // Clockwise or counter-clockwise rotation by 90 degree\n    rotate90degrees(this.bitmap, dstBuffer, steps === 1);\n\n    tmp = this.bitmap.width;\n    this.bitmap.width = this.bitmap.height;\n    this.bitmap.height = tmp;\n  }\n\n  this.bitmap.data = dstBuffer;\n}\n\n/**\n * Rotates an image clockwise by an arbitrary number of degrees. NB: 'this' must be a Jimp object.\n * @param {number} deg the number of degrees to rotate the image by\n * @param {string|boolean} mode (optional) resize mode or a boolean, if false then the width and height of the image will not be changed\n */\nfunction advancedRotate(deg, mode) {\n  deg %= 360;\n  const rad = (deg * Math.PI) / 180;\n  const cosine = Math.cos(rad);\n  const sine = Math.sin(rad);\n\n  // the final width and height will change if resize == true\n  let w = this.bitmap.width;\n  let h = this.bitmap.height;\n\n  if (mode === true || typeof mode === 'string') {\n    // resize the image to it maximum dimension and blit the existing image\n    // onto the center so that when it is rotated the image is kept in bounds\n\n    // http://stackoverflow.com/questions/3231176/how-to-get-size-of-a-rotated-rectangle\n    // Plus 1 border pixel to ensure to show all rotated result for some cases.\n    w =\n      Math.ceil(\n        Math.abs(this.bitmap.width * cosine) +\n          Math.abs(this.bitmap.height * sine)\n      ) + 1;\n    h =\n      Math.ceil(\n        Math.abs(this.bitmap.width * sine) +\n          Math.abs(this.bitmap.height * cosine)\n      ) + 1;\n    // Ensure destination to have even size to a better result.\n    if (w % 2 !== 0) {\n      w++;\n    }\n\n    if (h % 2 !== 0) {\n      h++;\n    }\n\n    const c = this.cloneQuiet();\n    this.scanQuiet(0, 0, this.bitmap.width, this.bitmap.height, function(\n      x,\n      y,\n      idx\n    ) {\n      this.bitmap.data.writeUInt32BE(this._background, idx);\n    });\n\n    const max = Math.max(w, h, this.bitmap.width, this.bitmap.height);\n    this.resize(max, max, mode);\n\n    this.blit(\n      c,\n      this.bitmap.width / 2 - c.bitmap.width / 2,\n      this.bitmap.height / 2 - c.bitmap.height / 2\n    );\n  }\n\n  const bW = this.bitmap.width;\n  const bH = this.bitmap.height;\n  const dstBuffer = Buffer.alloc(this.bitmap.data.length);\n\n  function createTranslationFunction(deltaX, deltaY) {\n    return function(x, y) {\n      return {\n        x: x + deltaX,\n        y: y + deltaY\n      };\n    };\n  }\n\n  const translate2Cartesian = createTranslationFunction(-(bW / 2), -(bH / 2));\n  const translate2Screen = createTranslationFunction(\n    bW / 2 + 0.5,\n    bH / 2 + 0.5\n  );\n\n  for (let y = 1; y <= bH; y++) {\n    for (let x = 1; x <= bW; x++) {\n      const cartesian = translate2Cartesian(x, y);\n      const source = translate2Screen(\n        cosine * cartesian.x - sine * cartesian.y,\n        cosine * cartesian.y + sine * cartesian.x\n      );\n      const dstIdx = (bW * (y - 1) + x - 1) << 2;\n\n      if (source.x >= 0 && source.x < bW && source.y >= 0 && source.y < bH) {\n        const srcIdx = ((bW * (source.y | 0) + source.x) | 0) << 2;\n        const pixelRGBA = this.bitmap.data.readUInt32BE(srcIdx);\n        dstBuffer.writeUInt32BE(pixelRGBA, dstIdx);\n      } else {\n        // reset off-image pixels\n        dstBuffer.writeUInt32BE(this._background, dstIdx);\n      }\n    }\n  }\n  this.bitmap.data = dstBuffer;\n\n  if (mode === true || typeof mode === 'string') {\n    // now crop the image to the final size\n    const x = bW / 2 - w / 2;\n    const y = bH / 2 - h / 2;\n    this.crop(x, y, w, h);\n  }\n}\n\nexport default () => ({\n  /**\n   * Rotates the image clockwise by a number of degrees. By default the width and height of the image will be resized appropriately.\n   * @param {number} deg the number of degrees to rotate the image by\n   * @param {string|boolean} mode (optional) resize mode or a boolean, if false then the width and height of the image will not be changed\n   * @param {function(Error, Jimp)} cb (optional) a callback for when complete\n   * @returns {Jimp} this for chaining of methods\n   */\n  rotate(deg, mode, cb) {\n    // enable overloading\n    if (typeof mode === 'undefined' || mode === null) {\n      // e.g. image.resize(120);\n      // e.g. image.resize(120, null, cb);\n      // e.g. image.resize(120, undefined, cb);\n      mode = true;\n    }\n\n    if (typeof mode === 'function' && typeof cb === 'undefined') {\n      // e.g. image.resize(120, cb);\n      cb = mode;\n      mode = true;\n    }\n\n    if (typeof deg !== 'number') {\n      return throwError.call(this, 'deg must be a number', cb);\n    }\n\n    if (typeof mode !== 'boolean' && typeof mode !== 'string') {\n      return throwError.call(this, 'mode must be a boolean or a string', cb);\n    }\n\n    if (deg % 90 === 0 && Boolean(mode) === false) {\n      simpleRotate.call(this, deg, cb);\n    } else {\n      advancedRotate.call(this, deg, mode, cb);\n    }\n\n    if (isNodePattern(cb)) {\n      cb.call(this, null, this);\n    }\n\n    return this;\n  }\n});\n"],"file":"index.js"}